<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.arc path {
  stroke: #fff;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

  var colorMap =
    {
      sleeping: "#999999",
      daylight: "#d8d8d8"
    };

  var translate = function(shape){
    return "translate(" + shape + ")";
  }

  var half = function(width, height){
     return width/ 2 + "," + height / 2;
  }

  var label = function(data){
    return data.data.part;
  }

  var value = function(data){
    return data.amount;
  }

  var clone_ = function(o){
     var out, v, key;
     out = Array.isArray(o) ? [] : {};
     for (key in o) {
         v = o[key];
         out[key] = (typeof v === "object") ? clone_(v) : v;
     }
     return out;
  }

  var printStatistics = function(slices){
    var total = 0, i;

    for(i = 0; i < slices.length; i++){
      total += slices[i].amount;
    }

    console.log("24h = "+ 24*60 + ", amount = " + total);
  }

  var splitIfNecessary = function(hourAbsolute){
    if(hourData.length>0){
      var firstMinute = hourAbsolute[0].start;
      var lastSlice = hourData[hourData.length - 1];
      var shift = 0;
      if(firstMinute > 0){
        
        var firstSlice = clone_(lastSlice);
        firstSlice.start = 0;
        firstSlice.end = firstMinute;
        shift = firstMinute;
        hourData.unshift(firstSlice);


        lastSlice.end -= shift;
      }
    }
    
    //TODO AGB implement this
    return hourData;
  }

  var toAmount = function(hourData){

    var hourAbsolute = toAbsolute(hourData);

    var splitData = splitIfNecessary(hourAbsolute);

    var slices = splitData.map(function(current){

      var difference = current.end - current.start;
      var color = current.sleeping ? colorMap.sleeping: colorMap.daylight;

      return {part:current.part, amount: difference, color: color};
    });

    printStatistics(slices);

    return slices;

  }

  var color = function(data){
    return data.data.color;
  }

  var getTimeInMinutes = function(string){
    var hourStart, minuteStart, absoluteStart, parts = string.split(":");

    hourStart = Number(parts[0]);
    minuteStart = Number(parts[1]);
    absoluteStart = hourStart * 60 + minuteStart;  

    return absoluteStart;
  }

  var toAbsolute = function(hourData){
    return hourData.map(function(current){

      var absoluteStart = getTimeInMinutes(current.start),
          absoluteEnd = getTimeInMinutes(current.end);

      if(absoluteEnd < absoluteStart){
        absoluteEnd += 24 * 60;
      }

      current.start = absoluteStart;
      current.end = absoluteEnd;

      return current;
    });
  }

var width = 960,
    height = 500,
    radius = Math.min(width, height) / 2;

var hourData = [
{part: "core", start: "8:00", end:"12:00", sleeping: true},
{part: "daylight", start: "12:00", end: "8:00", sleeping: false},
];


var data = toAmount(hourData);


var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(0);

var pie = d3.layout.pie()
    .sort(null)
    .value(value);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", translate( half(width,height)));

  var g = svg.selectAll(".arc")
      .data(pie(data))
    .enter().append("g")
      .attr("class", "arc");

  g.append("path")
      .attr("d", arc)
      .style("fill", color);

  g.append("text")
      .attr("transform", function(d) { return  translate(arc.centroid(d)); })
      .attr("dy", ".35em")
      .style("text-anchor", "middle")
      .text(label);



</script>
